<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLOBE Mosquito Habitat Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 280px;
    }

    .controls h3 {
      margin-bottom: 10px;
      font-size: 14px;
      color: #0b3d91;
    }

    .layer-toggle {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .layer-toggle input {
      margin-right: 8px;
    }

    .legend {
      position: absolute;
      bottom: 30px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 12px;
    }

    .legend h4 {
      margin-bottom: 8px;
      color: #333;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: white;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
      text-align: center;
    }

    .loading.hidden { display: none; }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0b3d91;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      position: absolute;
      bottom: 30px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 12px;
    }

    .stats strong {
      color: #0b3d91;
    }

    .popup-content h4 {
      color: #0b3d91;
      margin-bottom: 8px;
    }

    .popup-content p {
      margin: 4px 0;
      font-size: 12px;
    }

    .popup-content .label {
      font-weight: 600;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <h3>Map Layers</h3>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-observations" checked>
      GLOBE Observations
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-risk">
      Disease Risk Zones
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-heatmap">
      Density Heatmap
    </label>
  </div>

  <div class="legend">
    <h4>Mosquito Species</h4>
    <div class="legend-item">
      <div class="legend-color" style="background: #e74c3c;"></div>
      <span>Aedes (Dengue, Zika)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #9b59b6;"></div>
      <span>Anopheles (Malaria)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #3498db;"></div>
      <span>Culex (West Nile)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #95a5a6;"></div>
      <span>Unknown/Other</span>
    </div>
  </div>

  <div class="stats" id="stats">
    Loading observations...
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>Loading GLOBE data...</div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Leaflet MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <!-- Leaflet Heat -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([20, 0], 2);

    // Add tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | Data: <a href="https://observer.globe.gov">NASA GLOBE Observer</a>',
      maxZoom: 18
    }).addTo(map);

    // Layer groups
    const observationsLayer = L.markerClusterGroup({
      chunkedLoading: true,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      maxClusterRadius: 50
    });

    let heatmapLayer = null;
    let riskZonesLayer = L.layerGroup();
    let observationsData = [];

    // Species color mapping
    const speciesColors = {
      'aedes': '#e74c3c',
      'anopheles': '#9b59b6',
      'culex': '#3498db',
      'unknown': '#95a5a6'
    };

    function getSpeciesFromData(props) {
      const genus = (props.mosquitoGenus || props.genus || '').toLowerCase();
      if (genus.includes('aedes')) return 'aedes';
      if (genus.includes('anopheles')) return 'anopheles';
      if (genus.includes('culex')) return 'culex';
      return 'unknown';
    }

    function createMarkerIcon(species) {
      const color = speciesColors[species] || speciesColors.unknown;
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          width: 12px;
          height: 12px;
          background: ${color};
          border: 2px solid white;
          border-radius: 50%;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function createPopupContent(props) {
      const species = getSpeciesFromData(props);
      const speciesName = species.charAt(0).toUpperCase() + species.slice(1);

      return `
        <div class="popup-content">
          <h4>Mosquito Habitat Observation</h4>
          <p><span class="label">Species:</span> ${speciesName}</p>
          <p><span class="label">Date:</span> ${formatDate(props.measuredDate || props.observationDate)}</p>
          <p><span class="label">Water Source:</span> ${props.waterSource || props.waterSourceType || 'Not specified'}</p>
          <p><span class="label">Larvae Present:</span> ${props.larvaePresent || props.larvaeCount || 'Unknown'}</p>
          ${props.countryName ? `<p><span class="label">Location:</span> ${props.countryName}</p>` : ''}
        </div>
      `;
    }

    // Fetch real data from GLOBE API
    async function fetchGlobeData() {
      const loading = document.getElementById('loading');
      const stats = document.getElementById('stats');

      try {
        // Calculate date range (last 2 years for more data)
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - 730 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        // Use the proxy endpoint
        const apiUrl = `/api/globe/search/v1/measurement/protocol/measureddate/?protocols=mosquito_habitat_mapper&startdate=${startDate}&enddate=${endDate}&geojson=TRUE&sample=FALSE`;

        console.log('Fetching from:', apiUrl);

        const response = await fetch(apiUrl);

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        console.log('GLOBE API response:', data);

        if (data.features && data.features.length > 0) {
          observationsData = data.features;
          displayObservations(data.features);
          stats.innerHTML = `<strong>${data.features.length.toLocaleString()}</strong> observations loaded`;
        } else {
          // Fallback: try direct API call
          console.log('No data from proxy, trying direct API...');
          await fetchDirectFromGlobe();
        }
      } catch (error) {
        console.error('Proxy fetch failed:', error);
        // Fallback to direct API
        await fetchDirectFromGlobe();
      } finally {
        loading.classList.add('hidden');
      }
    }

    async function fetchDirectFromGlobe() {
      const stats = document.getElementById('stats');

      try {
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - 730 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        const directUrl = `https://api.globe.gov/search/v1/measurement/protocol/measureddate/?protocols=mosquito_habitat_mapper&startdate=${startDate}&enddate=${endDate}&geojson=TRUE&sample=FALSE`;

        const response = await fetch(directUrl);
        const data = await response.json();

        if (data.features && data.features.length > 0) {
          observationsData = data.features;
          displayObservations(data.features);
          stats.innerHTML = `<strong>${data.features.length.toLocaleString()}</strong> observations loaded`;
        } else {
          stats.innerHTML = 'No observations found';
          addDemoData();
        }
      } catch (error) {
        console.error('Direct API also failed:', error);
        stats.innerHTML = 'Using demo data (API unavailable)';
        addDemoData();
      }
    }

    function displayObservations(features) {
      observationsLayer.clearLayers();
      const heatPoints = [];

      features.forEach(feature => {
        if (!feature.geometry || !feature.geometry.coordinates) return;

        const [lng, lat] = feature.geometry.coordinates;
        const props = feature.properties || {};
        const species = getSpeciesFromData(props);

        const marker = L.marker([lat, lng], {
          icon: createMarkerIcon(species)
        });

        marker.bindPopup(createPopupContent(props));
        observationsLayer.addLayer(marker);

        heatPoints.push([lat, lng, 0.5]);
      });

      map.addLayer(observationsLayer);

      // Create heatmap layer (hidden by default)
      if (heatmapLayer) {
        map.removeLayer(heatmapLayer);
      }
      heatmapLayer = L.heatLayer(heatPoints, {
        radius: 25,
        blur: 15,
        maxZoom: 10,
        gradient: {
          0.2: '#ffffb2',
          0.4: '#fecc5c',
          0.6: '#fd8d3c',
          0.8: '#f03b20',
          1.0: '#bd0026'
        }
      });
    }

    // Demo data fallback
    function addDemoData() {
      const demoLocations = [
        { lat: 29.6516, lng: -82.3248, species: 'aedes', country: 'USA (Florida)' },
        { lat: 25.7617, lng: -80.1918, species: 'aedes', country: 'USA (Miami)' },
        { lat: -23.5505, lng: -46.6333, species: 'aedes', country: 'Brazil' },
        { lat: 19.4326, lng: -99.1332, species: 'aedes', country: 'Mexico' },
        { lat: 14.5995, lng: 120.9842, species: 'aedes', country: 'Philippines' },
        { lat: -1.2921, lng: 36.8219, species: 'anopheles', country: 'Kenya' },
        { lat: 6.5244, lng: 3.3792, species: 'anopheles', country: 'Nigeria' },
        { lat: -6.2088, lng: 106.8456, species: 'culex', country: 'Indonesia' },
        { lat: 13.7563, lng: 100.5018, species: 'aedes', country: 'Thailand' },
        { lat: 28.6139, lng: 77.2090, species: 'anopheles', country: 'India' }
      ];

      const features = demoLocations.map((loc, i) => ({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [loc.lng, loc.lat] },
        properties: {
          mosquitoGenus: loc.species,
          countryName: loc.country,
          measuredDate: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
          waterSource: ['Container', 'Pond', 'Tire', 'Drainage'][Math.floor(Math.random() * 4)],
          larvaePresent: Math.random() > 0.5 ? 'Yes' : 'No'
        }
      }));

      observationsData = features;
      displayObservations(features);
      document.getElementById('stats').innerHTML = `<strong>${features.length}</strong> demo observations`;
    }

    // Add demo risk zones
    function addRiskZones() {
      riskZonesLayer.clearLayers();

      const riskZones = [
        { center: [9.0820, -79.5], radius: 500000, risk: 'high', name: 'Central America' },
        { center: [-10, -55], radius: 800000, risk: 'high', name: 'Amazon Basin' },
        { center: [5, 20], radius: 600000, risk: 'high', name: 'Central Africa' },
        { center: [15, 100], radius: 500000, risk: 'medium', name: 'Southeast Asia' },
        { center: [25, -80], radius: 300000, risk: 'medium', name: 'Florida/Caribbean' }
      ];

      const riskColors = {
        high: { color: '#e74c3c', fillColor: '#e74c3c', fillOpacity: 0.2 },
        medium: { color: '#f39c12', fillColor: '#f39c12', fillOpacity: 0.15 },
        low: { color: '#27ae60', fillColor: '#27ae60', fillOpacity: 0.1 }
      };

      riskZones.forEach(zone => {
        const style = riskColors[zone.risk];
        const circle = L.circle(zone.center, {
          radius: zone.radius,
          color: style.color,
          fillColor: style.fillColor,
          fillOpacity: style.fillOpacity,
          weight: 2
        });

        circle.bindPopup(`
          <div class="popup-content">
            <h4>${zone.name}</h4>
            <p><span class="label">Risk Level:</span> ${zone.risk.toUpperCase()}</p>
            <p>Based on environmental conditions favorable for mosquito breeding.</p>
          </div>
        `);

        riskZonesLayer.addLayer(circle);
      });
    }

    // Layer toggle handlers
    document.getElementById('toggle-observations').addEventListener('change', function() {
      if (this.checked) {
        map.addLayer(observationsLayer);
      } else {
        map.removeLayer(observationsLayer);
      }
    });

    document.getElementById('toggle-risk').addEventListener('change', function() {
      if (this.checked) {
        addRiskZones();
        map.addLayer(riskZonesLayer);
      } else {
        map.removeLayer(riskZonesLayer);
      }
    });

    document.getElementById('toggle-heatmap').addEventListener('change', function() {
      if (this.checked && heatmapLayer) {
        map.addLayer(heatmapLayer);
        map.removeLayer(observationsLayer);
        document.getElementById('toggle-observations').checked = false;
      } else if (heatmapLayer) {
        map.removeLayer(heatmapLayer);
      }
    });

    // Initialize
    fetchGlobeData();
  </script>
</body>
</html>
