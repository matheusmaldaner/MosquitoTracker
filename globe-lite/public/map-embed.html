<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLOBE Mosquito Habitat Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 280px;
    }

    .controls h3 {
      margin-bottom: 10px;
      font-size: 14px;
      color: #0b3d91;
    }

    .layer-toggle {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .layer-toggle input {
      margin-right: 8px;
    }

    /* Legend container to stack legends vertically */
    .legend-container {
      position: absolute;
      bottom: 30px;
      left: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }

    .legend {
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 12px;
    }

    .legend h4 {
      margin-bottom: 8px;
      color: #333;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: white;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
      text-align: center;
    }

    .loading.hidden { display: none; }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0b3d91;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats {
      position: absolute;
      bottom: 30px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 12px;
    }

    .stats strong {
      color: #0b3d91;
    }

    .popup-content h4 {
      color: #0b3d91;
      margin-bottom: 8px;
    }

    .popup-content p {
      margin: 4px 0;
      font-size: 12px;
    }

    .popup-content .label {
      font-weight: 600;
      color: #555;
    }

    .control-section {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      margin: 12px 0 6px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }

    .control-section:first-of-type {
      border-top: none;
      margin-top: 0;
    }

    .satellite-legend {
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 11px;
      display: none;
    }

    .satellite-legend h4 {
      margin-bottom: 8px;
      color: #333;
      font-size: 12px;
    }

    .satellite-legend .legend-item {
      margin-bottom: 6px;
    }

    .satellite-legend .legend-gradient {
      width: 80px;
      height: 12px;
      border-radius: 2px;
      margin-right: 8px;
      display: inline-block;
      vertical-align: middle;
    }

    .data-date {
      font-size: 10px;
      color: #888;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <h3>Map Layers</h3>

    <p class="control-section">GLOBE Data</p>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-observations" checked>
      Mosquito Observations
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-risk">
      Disease Risk Zones
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-heatmap">
      Density Heatmap
    </label>

    <p class="control-section">NASA Satellite Data</p>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-ndvi">
      MODIS NDVI (Vegetation)
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-temp">
      Land Surface Temp
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-precip">
      GPM Precipitation
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-water">
      MODIS Water Bodies
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-flood">
      VIIRS Flood Detection
    </label>
    <label class="layer-toggle">
      <input type="checkbox" id="toggle-truecolor">
      VIIRS True Color
    </label>
  </div>

  <div class="legend-container">
    <div class="satellite-legend" id="satellite-legend">
      <h4>NASA Satellite Data</h4>
      <div class="legend-item" id="legend-ndvi" style="display:none;">
        <span class="legend-gradient" style="background: linear-gradient(to right, #8B4513, #FFFF00, #228B22);"></span>
        <span>NDVI: Low - High vegetation</span>
      </div>
      <div class="legend-item" id="legend-temp" style="display:none;">
        <span class="legend-gradient" style="background: linear-gradient(to right, #0000FF, #00FFFF, #FFFF00, #FF0000);"></span>
        <span>Temp: Cold - Hot</span>
      </div>
      <div class="legend-item" id="legend-precip" style="display:none;">
        <span class="legend-gradient" style="background: linear-gradient(to right, #FFFFFF, #87CEEB, #0000FF, #00008B);"></span>
        <span>Precip: Dry - Heavy rain</span>
      </div>
      <div class="legend-item" id="legend-water" style="display:none;">
        <span class="legend-gradient" style="background: #0066CC;"></span>
        <span>Water Bodies (blue)</span>
      </div>
      <div class="legend-item" id="legend-flood" style="display:none;">
        <span class="legend-gradient" style="background: linear-gradient(to right, #FF6600, #FF0000);"></span>
        <span>Flood: Recent flooding</span>
      </div>
      <div class="data-date" id="satellite-date">
        Data from: Loading...
      </div>
    </div>

    <div class="legend">
      <h4>Mosquito Species</h4>
      <div class="legend-item">
        <div class="legend-color" style="background: #e74c3c;"></div>
        <span>Aedes (Dengue, Zika)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #9b59b6;"></div>
        <span>Anopheles (Malaria)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #3498db;"></div>
        <span>Culex (West Nile)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #95a5a6;"></div>
        <span>Unknown/Other</span>
      </div>
    </div>
  </div>

  <div class="stats" id="stats">
    Loading observations...
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>Loading GLOBE data...</div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Leaflet MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <!-- Leaflet Heat -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([20, 0], 2);

    // Add tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | Data: <a href="https://observer.globe.gov">NASA GLOBE Observer</a>',
      maxZoom: 18
    }).addTo(map);

    // ===========================================
    // NASA GIBS Satellite Layers
    // ===========================================

    // Helper function to get date string for GIBS (data has latency)
    function getGIBSDate(daysAgo = 1) {
      const date = new Date();
      date.setDate(date.getDate() - daysAgo);
      return date.toISOString().split('T')[0];
    }

    // Store dates for display
    const gibsDates = {
      ndvi: getGIBSDate(10),      // NDVI updates every 8 days, use 10 for safety
      temp: getGIBSDate(2),       // Temperature - 2 day latency
      precip: getGIBSDate(3),     // Precipitation - 3 day latency
      trueColor: getGIBSDate(1)   // True color - 1 day latency
    };

    // MODIS NDVI Layer (Vegetation Health - green areas = potential mosquito habitat)
    const modisNDVILayer = L.tileLayer(
      'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_NDVI_8Day/default/' + gibsDates.ndvi + '/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png',
      {
        tileSize: 256,
        opacity: 0.7,
        attribution: 'NASA GIBS MODIS NDVI',
        maxZoom: 9,
        minZoom: 1
      }
    );

    // MODIS Land Surface Temperature Layer (mosquitoes thrive 15-40Â°C)
    const modisTempLayer = L.tileLayer(
      'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/' + gibsDates.temp + '/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png',
      {
        tileSize: 256,
        opacity: 0.7,
        attribution: 'NASA GIBS MODIS LST',
        maxZoom: 7,
        minZoom: 1
      }
    );

    // GPM Precipitation Layer (rainfall creates breeding sites)
    const gpmPrecipLayer = L.tileLayer(
      'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/GPM_3IMERGDF_06_precipitationCal/default/' + gibsDates.precip + '/GoogleMapsCompatible_Level6/{z}/{y}/{x}.png',
      {
        tileSize: 256,
        opacity: 0.6,
        attribution: 'NASA GIBS GPM IMERG',
        maxZoom: 6,
        minZoom: 1
      }
    );

    // VIIRS True Color (for visual reference)
    const viirsLayer = L.tileLayer(
      'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_CorrectedReflectance_TrueColor/default/' + gibsDates.trueColor + '/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg',
      {
        tileSize: 256,
        opacity: 0.9,
        attribution: 'NASA GIBS VIIRS',
        maxZoom: 9,
        minZoom: 1
      }
    );

    // MODIS Water Mask Layer (identifies water bodies - potential mosquito breeding sites)
    const modisWaterLayer = L.tileLayer(
      'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Water_Mask/default/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png',
      {
        tileSize: 256,
        opacity: 0.7,
        attribution: 'NASA GIBS MODIS Water Mask',
        maxZoom: 9,
        minZoom: 1
      }
    );

    // VIIRS Flood Detection (shows recent flooding - creates breeding habitat)
    const viirsFloodLayer = L.tileLayer(
      'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_NOAA20_Flood_Detection_3Day_Composite/default/' + gibsDates.trueColor + '/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png',
      {
        tileSize: 256,
        opacity: 0.8,
        attribution: 'NASA GIBS VIIRS Flood',
        maxZoom: 8,
        minZoom: 1
      }
    );

    // Store satellite layers for toggle controls
    const satelliteLayers = {
      ndvi: modisNDVILayer,
      temperature: modisTempLayer,
      precipitation: gpmPrecipLayer,
      trueColor: viirsLayer,
      water: modisWaterLayer,
      flood: viirsFloodLayer
    };

    // Layer groups
    const observationsLayer = L.markerClusterGroup({
      chunkedLoading: true,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      maxClusterRadius: 50
    });

    let heatmapLayer = null;
    let riskZonesLayer = L.layerGroup();
    let observationsData = [];

    // Species color mapping
    const speciesColors = {
      'aedes': '#e74c3c',
      'anopheles': '#9b59b6',
      'culex': '#3498db',
      'unknown': '#95a5a6'
    };

    function getSpeciesFromData(props) {
      const genus = (props.mosquitoGenus || props.genus || '').toLowerCase();
      if (genus.includes('aedes')) return 'aedes';
      if (genus.includes('anopheles')) return 'anopheles';
      if (genus.includes('culex')) return 'culex';
      return 'unknown';
    }

    function createMarkerIcon(species) {
      const color = speciesColors[species] || speciesColors.unknown;
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          width: 12px;
          height: 12px;
          background: ${color};
          border: 2px solid white;
          border-radius: 50%;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function createPopupContent(props) {
      const species = getSpeciesFromData(props);
      const speciesName = species.charAt(0).toUpperCase() + species.slice(1);

      return `
        <div class="popup-content">
          <h4>Mosquito Habitat Observation</h4>
          <p><span class="label">Species:</span> ${speciesName}</p>
          <p><span class="label">Date:</span> ${formatDate(props.measuredDate || props.observationDate)}</p>
          <p><span class="label">Water Source:</span> ${props.waterSource || props.waterSourceType || 'Not specified'}</p>
          <p><span class="label">Larvae Present:</span> ${props.larvaePresent || props.larvaeCount || 'Unknown'}</p>
          ${props.countryName ? `<p><span class="label">Location:</span> ${props.countryName}</p>` : ''}
        </div>
      `;
    }

    // Fetch real data from GLOBE API
    async function fetchGlobeData() {
      const loading = document.getElementById('loading');
      const stats = document.getElementById('stats');

      try {
        // Calculate date range (last 2 years for more data)
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - 730 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        // Use the proxy endpoint
        const apiUrl = `/api/globe/search/v1/measurement/protocol/measureddate/?protocols=mosquito_habitat_mapper&startdate=${startDate}&enddate=${endDate}&geojson=TRUE&sample=FALSE`;

        console.log('Fetching from:', apiUrl);

        const response = await fetch(apiUrl);

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        console.log('GLOBE API response:', data);

        if (data.features && data.features.length > 0) {
          observationsData = data.features;
          displayObservations(data.features);
          stats.innerHTML = `<strong>${data.features.length.toLocaleString()}</strong> observations loaded`;
        } else {
          // Fallback: try direct API call
          console.log('No data from proxy, trying direct API...');
          await fetchDirectFromGlobe();
        }
      } catch (error) {
        console.error('Proxy fetch failed:', error);
        // Fallback to direct API
        await fetchDirectFromGlobe();
      } finally {
        loading.classList.add('hidden');
      }
    }

    async function fetchDirectFromGlobe() {
      const stats = document.getElementById('stats');

      try {
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - 730 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        const directUrl = `https://api.globe.gov/search/v1/measurement/protocol/measureddate/?protocols=mosquito_habitat_mapper&startdate=${startDate}&enddate=${endDate}&geojson=TRUE&sample=FALSE`;

        const response = await fetch(directUrl);
        const data = await response.json();

        if (data.features && data.features.length > 0) {
          observationsData = data.features;
          displayObservations(data.features);
          stats.innerHTML = `<strong>${data.features.length.toLocaleString()}</strong> observations loaded`;
        } else {
          stats.innerHTML = 'No observations found';
          addDemoData();
        }
      } catch (error) {
        console.error('Direct API also failed:', error);
        stats.innerHTML = 'Using demo data (API unavailable)';
        addDemoData();
      }
    }

    function displayObservations(features) {
      observationsLayer.clearLayers();
      const heatPoints = [];

      features.forEach(feature => {
        if (!feature.geometry || !feature.geometry.coordinates) return;

        const [lng, lat] = feature.geometry.coordinates;
        const props = feature.properties || {};
        const species = getSpeciesFromData(props);

        const marker = L.marker([lat, lng], {
          icon: createMarkerIcon(species)
        });

        marker.bindPopup(createPopupContent(props));
        observationsLayer.addLayer(marker);

        heatPoints.push([lat, lng, 0.5]);
      });

      map.addLayer(observationsLayer);

      // Create heatmap layer (hidden by default)
      if (heatmapLayer) {
        map.removeLayer(heatmapLayer);
      }
      heatmapLayer = L.heatLayer(heatPoints, {
        radius: 25,
        blur: 15,
        maxZoom: 10,
        gradient: {
          0.2: '#ffffb2',
          0.4: '#fecc5c',
          0.6: '#fd8d3c',
          0.8: '#f03b20',
          1.0: '#bd0026'
        }
      });
    }

    // Demo data fallback
    function addDemoData() {
      const demoLocations = [
        { lat: 29.6516, lng: -82.3248, species: 'aedes', country: 'USA (Florida)' },
        { lat: 25.7617, lng: -80.1918, species: 'aedes', country: 'USA (Miami)' },
        { lat: -23.5505, lng: -46.6333, species: 'aedes', country: 'Brazil' },
        { lat: 19.4326, lng: -99.1332, species: 'aedes', country: 'Mexico' },
        { lat: 14.5995, lng: 120.9842, species: 'aedes', country: 'Philippines' },
        { lat: -1.2921, lng: 36.8219, species: 'anopheles', country: 'Kenya' },
        { lat: 6.5244, lng: 3.3792, species: 'anopheles', country: 'Nigeria' },
        { lat: -6.2088, lng: 106.8456, species: 'culex', country: 'Indonesia' },
        { lat: 13.7563, lng: 100.5018, species: 'aedes', country: 'Thailand' },
        { lat: 28.6139, lng: 77.2090, species: 'anopheles', country: 'India' }
      ];

      const features = demoLocations.map((loc, i) => ({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [loc.lng, loc.lat] },
        properties: {
          mosquitoGenus: loc.species,
          countryName: loc.country,
          measuredDate: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
          waterSource: ['Container', 'Pond', 'Tire', 'Drainage'][Math.floor(Math.random() * 4)],
          larvaePresent: Math.random() > 0.5 ? 'Yes' : 'No'
        }
      }));

      observationsData = features;
      displayObservations(features);
      document.getElementById('stats').innerHTML = `<strong>${features.length}</strong> demo observations`;
    }

    // Calculate dynamic risk zones based on observation clusters
    function addRiskZones() {
      riskZonesLayer.clearLayers();

      if (!observationsData || observationsData.length === 0) {
        console.log('No observation data for risk calculation');
        return;
      }

      // Grid-based clustering for risk calculation
      const gridSize = 2; // degrees
      const grid = {};

      // Count observations per grid cell
      observationsData.forEach(feature => {
        if (!feature.geometry || !feature.geometry.coordinates) return;
        const [lng, lat] = feature.geometry.coordinates;
        const gridKey = `${Math.floor(lat / gridSize) * gridSize},${Math.floor(lng / gridSize) * gridSize}`;

        if (!grid[gridKey]) {
          grid[gridKey] = { count: 0, lat: 0, lng: 0, species: {} };
        }
        grid[gridKey].count++;
        grid[gridKey].lat += lat;
        grid[gridKey].lng += lng;

        // Track species for risk assessment
        const props = feature.properties || {};
        const species = getSpeciesFromData(props);
        grid[gridKey].species[species] = (grid[gridKey].species[species] || 0) + 1;
      });

      // Calculate risk and create zones
      const riskColors = {
        high: { color: '#e74c3c', fillColor: '#e74c3c', fillOpacity: 0.25 },
        medium: { color: '#f39c12', fillColor: '#f39c12', fillOpacity: 0.2 },
        low: { color: '#27ae60', fillColor: '#27ae60', fillOpacity: 0.15 }
      };

      Object.keys(grid).forEach(key => {
        const cell = grid[key];
        if (cell.count < 2) return; // Skip cells with too few observations

        const centerLat = cell.lat / cell.count;
        const centerLng = cell.lng / cell.count;

        // Calculate risk level based on:
        // 1. Observation density
        // 2. Presence of disease-carrying species (Aedes, Anopheles)
        let riskScore = 0;
        riskScore += Math.min(cell.count * 10, 50); // Density (max 50 points)
        riskScore += (cell.species.aedes || 0) * 15; // Aedes = Dengue/Zika
        riskScore += (cell.species.anopheles || 0) * 15; // Anopheles = Malaria
        riskScore += (cell.species.culex || 0) * 5; // Culex = West Nile

        let risk = 'low';
        let radius = 100000; // 100km base
        if (riskScore >= 80) {
          risk = 'high';
          radius = 150000;
        } else if (riskScore >= 40) {
          risk = 'medium';
          radius = 120000;
        }

        const style = riskColors[risk];
        const circle = L.circle([centerLat, centerLng], {
          radius: radius,
          color: style.color,
          fillColor: style.fillColor,
          fillOpacity: style.fillOpacity,
          weight: 2
        });

        // Build species breakdown
        const speciesBreakdown = Object.entries(cell.species)
          .map(([sp, count]) => `${sp}: ${count}`)
          .join(', ');

        circle.bindPopup(`
          <div class="popup-content">
            <h4>Risk Zone (Calculated)</h4>
            <p><span class="label">Risk Level:</span> ${risk.toUpperCase()}</p>
            <p><span class="label">Observations:</span> ${cell.count}</p>
            <p><span class="label">Species:</span> ${speciesBreakdown}</p>
            <p><span class="label">Risk Score:</span> ${riskScore}/100</p>
            <p style="font-size:10px; color:#666; margin-top:8px;">
              Calculated from GLOBE observation density and species composition.
            </p>
          </div>
        `);

        riskZonesLayer.addLayer(circle);
      });

      console.log(`Created ${Object.keys(grid).length} risk zones from ${observationsData.length} observations`);
    }

    // Layer toggle handlers
    document.getElementById('toggle-observations').addEventListener('change', function() {
      if (this.checked) {
        map.addLayer(observationsLayer);
      } else {
        map.removeLayer(observationsLayer);
      }
    });

    document.getElementById('toggle-risk').addEventListener('change', function() {
      if (this.checked) {
        addRiskZones();
        map.addLayer(riskZonesLayer);
      } else {
        map.removeLayer(riskZonesLayer);
      }
    });

    document.getElementById('toggle-heatmap').addEventListener('change', function() {
      if (this.checked && heatmapLayer) {
        map.addLayer(heatmapLayer);
        map.removeLayer(observationsLayer);
        document.getElementById('toggle-observations').checked = false;
      } else if (heatmapLayer) {
        map.removeLayer(heatmapLayer);
      }
    });

    // ===========================================
    // Satellite Layer Toggle Handlers
    // ===========================================

    function updateSatelliteLegend() {
      const ndviOn = document.getElementById('toggle-ndvi').checked;
      const tempOn = document.getElementById('toggle-temp').checked;
      const precipOn = document.getElementById('toggle-precip').checked;
      const waterOn = document.getElementById('toggle-water').checked;
      const floodOn = document.getElementById('toggle-flood').checked;
      const trueColorOn = document.getElementById('toggle-truecolor').checked;

      const anyActive = ndviOn || tempOn || precipOn || waterOn || floodOn || trueColorOn;

      const legendEl = document.getElementById('satellite-legend');
      legendEl.style.display = anyActive ? 'block' : 'none';

      // Show/hide individual legend items
      document.getElementById('legend-ndvi').style.display = ndviOn ? 'flex' : 'none';
      document.getElementById('legend-temp').style.display = tempOn ? 'flex' : 'none';
      document.getElementById('legend-precip').style.display = precipOn ? 'flex' : 'none';
      document.getElementById('legend-water').style.display = waterOn ? 'flex' : 'none';
      document.getElementById('legend-flood').style.display = floodOn ? 'flex' : 'none';

      // Update date display
      if (anyActive) {
        let dateText = 'Data: ';
        const dates = [];
        if (ndviOn) dates.push(`NDVI ${gibsDates.ndvi}`);
        if (tempOn) dates.push(`Temp ${gibsDates.temp}`);
        if (precipOn) dates.push(`Precip ${gibsDates.precip}`);
        if (waterOn) dates.push('Water (static)');
        if (floodOn) dates.push(`Flood ${gibsDates.trueColor}`);
        document.getElementById('satellite-date').textContent = dateText + dates.join(', ');
      }
    }

    document.getElementById('toggle-ndvi').addEventListener('change', function() {
      if (this.checked) {
        map.addLayer(satelliteLayers.ndvi);
      } else {
        map.removeLayer(satelliteLayers.ndvi);
      }
      updateSatelliteLegend();
    });

    document.getElementById('toggle-temp').addEventListener('change', function() {
      if (this.checked) {
        map.addLayer(satelliteLayers.temperature);
      } else {
        map.removeLayer(satelliteLayers.temperature);
      }
      updateSatelliteLegend();
    });

    document.getElementById('toggle-precip').addEventListener('change', function() {
      if (this.checked) {
        map.addLayer(satelliteLayers.precipitation);
      } else {
        map.removeLayer(satelliteLayers.precipitation);
      }
      updateSatelliteLegend();
    });

    document.getElementById('toggle-water').addEventListener('change', function() {
      if (this.checked) {
        map.addLayer(satelliteLayers.water);
      } else {
        map.removeLayer(satelliteLayers.water);
      }
      updateSatelliteLegend();
    });

    document.getElementById('toggle-flood').addEventListener('change', function() {
      if (this.checked) {
        map.addLayer(satelliteLayers.flood);
      } else {
        map.removeLayer(satelliteLayers.flood);
      }
      updateSatelliteLegend();
    });

    document.getElementById('toggle-truecolor').addEventListener('change', function() {
      if (this.checked) {
        // True color should go below other layers
        map.addLayer(satelliteLayers.trueColor);
        satelliteLayers.trueColor.bringToBack();
      } else {
        map.removeLayer(satelliteLayers.trueColor);
      }
      updateSatelliteLegend();
    });

    // Initialize
    fetchGlobeData();
  </script>
</body>
</html>
